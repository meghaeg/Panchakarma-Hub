{% extends "base.html" %}

{% block title %}Book Appointment - Panchakarma Portal{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-calendar-plus"></i> Book Panchakarma Therapy Appointment</h4>
                </div>
                <div class="card-body">
                    <form id="bookingForm">
                        <!-- Centre Selection -->
                        <div class="mb-4">
                            <label for="centre" class="form-label">Select Centre *</label>
                            <select class="form-control" id="centre" required>
                                <option value="">Choose a centre...</option>
                                {% for centre in centres %}
                                <option value="{{ centre.centre_id }}" data-city="{{ centre.city }}" data-state="{{ centre.state }}">
                                    {{ centre.name }} - {{ centre.city }}, {{ centre.state }}
                                    {% if centre.nabh_accredited %}<span class="badge bg-success">NABH</span>{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Therapy Type -->
                        <div class="mb-4">
                            <label for="therapyType" class="form-label">Therapy Type *</label>
                            <select class="form-control" id="therapyType" required>
                                <option value="">Select therapy type...</option>
                                <option value="Abhyanga">Abhyanga (Full Body Massage)</option>
                                <option value="Shirodhara">Shirodhara (Oil Pouring Therapy)</option>
                                <option value="Panchakarma Full">Complete Panchakarma (21 days)</option>
                                <option value="Panchakarma Short">Short Panchakarma (7 days)</option>
                                <option value="Udvartana">Udvartana (Herbal Powder Massage)</option>
                                <option value="Nasya">Nasya (Nasal Therapy)</option>
                                <option value="Basti">Basti (Medicated Enema)</option>
                                <option value="Virechana">Virechana (Purgation Therapy)</option>
                            </select>
                        </div>

                        <!-- Date Selection -->
                        <div class="mb-4">
                            <label for="preferredDate" class="form-label">Preferred Date *</label>
                            <input type="date" class="form-control" id="preferredDate" required>
                            <small class="form-text text-muted">Please select a date within the next 5 days. Time slot and doctor will be automatically assigned based on availability.</small>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-4">
                            <label for="notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="notes" rows="3" 
                                      placeholder="Any specific requirements or health conditions to mention..."></textarea>
                        </div>

                        <!-- Terms -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    I agree to the booking terms and understand that I need to arrive 15 minutes early
                                </label>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-calendar-check"></i> Book Appointment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set date restrictions (next 5 days only)
    const dateInput = document.getElementById('preferredDate');
    const today = new Date();
    const maxDate = new Date(today);
    maxDate.setDate(today.getDate() + 5);
    
    dateInput.min = today.toISOString().split('T')[0];
    dateInput.max = maxDate.toISOString().split('T')[0];
    
    // Handle form submission
    const bookingForm = document.getElementById('bookingForm');
    bookingForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitButton.disabled = true;
        
        // Validate date selection
        const selectedDate = new Date(document.getElementById('preferredDate').value);
        if (selectedDate < today || selectedDate > maxDate) {
            alert('Please select a date within the next 5 days');
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
            return;
        }
        
        const formData = {
            centre_id: document.getElementById('centre').value,
            therapy_type: document.getElementById('therapyType').value,
            preferred_date: document.getElementById('preferredDate').value,
            notes: document.getElementById('notes').value
        };
        
        try {
            const response = await fetch('/patient/book-appointment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Appointment booked successfully! Check your email for appointment details and pre-Panchakarma instructions.');
                window.location.href = '/patient/dashboard';
            } else {
                alert(result.message || 'Booking failed');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        } catch (error) {
            console.error('Booking error:', error);
            alert('Booking failed. Please try again.');
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    });
});
</script>
{% endblock %}
