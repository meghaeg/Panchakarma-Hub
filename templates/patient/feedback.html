{% extends "base.html" %}

{% block title %}Submit Feedback - Panchakarma Portal{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-comment"></i> Submit Feedback</h4>
                </div>
                <div class="card-body">
                    {% if appointments %}
                    <form id="feedbackForm">
                        <!-- Appointment Selection -->
                        <div class="mb-4">
                            <label for="appointment" class="form-label">Select Completed Appointment *</label>
                            <select class="form-control" id="appointment" required>
                                <option value="">Choose an appointment...</option>
                                {% for appointment in appointments %}
                                <option value="{{ appointment.appointment_id }}" 
                                        data-doctor="{{ appointment.doctor_id }}" 
                                        data-centre="{{ appointment.centre_id }}">
                                    {{ appointment.therapy_type }} - {{ appointment.appointment_date if appointment.appointment_date else 'N/A' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Feedback Type -->
                        <div class="mb-4">
                            <label for="feedbackType" class="form-label">Feedback For *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="feedbackType" id="doctorFeedback" value="doctor" checked>
                                <label class="btn btn-outline-primary" for="doctorFeedback">
                                    <i class="fas fa-user-md"></i> Doctor
                                </label>
                                
                                <input type="radio" class="btn-check" name="feedbackType" id="centreFeedback" value="centre">
                                <label class="btn btn-outline-primary" for="centreFeedback">
                                    <i class="fas fa-hospital"></i> Centre
                                </label>
                            </div>
                        </div>

                        <!-- Rating -->
                        <div class="mb-4">
                            <label class="form-label">Rating *</label>
                            <div class="rating-container text-center">
                                <div class="star-rating">
                                    <input type="radio" name="rating" id="star5" value="5">
                                    <label for="star5" class="star">★</label>
                                    <input type="radio" name="rating" id="star4" value="4">
                                    <label for="star4" class="star">★</label>
                                    <input type="radio" name="rating" id="star3" value="3">
                                    <label for="star3" class="star">★</label>
                                    <input type="radio" name="rating" id="star2" value="2">
                                    <label for="star2" class="star">★</label>
                                    <input type="radio" name="rating" id="star1" value="1">
                                    <label for="star1" class="star">★</label>
                                </div>
                                <p class="mt-2 text-muted">Click on stars to rate</p>
                            </div>
                        </div>

                        <!-- Comments -->
                        <div class="mb-4">
                            <label for="comments" class="form-label">Comments *</label>
                            <textarea class="form-control" id="comments" rows="5" required
                                      placeholder="Please share your experience and suggestions for improvement..."></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane"></i> Submit Feedback
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-clipboard-list text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">No Completed Appointments</h5>
                        <p class="text-muted">You can submit feedback only after completing a therapy session</p>
                        <a href="{{ url_for('patient.dashboard') }}" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.star-rating {
    display: inline-flex;
    flex-direction: row-reverse;
    font-size: 2rem;
}

.star-rating input {
    display: none;
}

.star-rating label {
    color: #ddd;
    cursor: pointer;
    transition: color 0.3s;
}

.star-rating input:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
    color: #F4A460;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const feedbackForm = document.getElementById('feedbackForm');
    
    if (feedbackForm) {
        feedbackForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const appointment = document.getElementById('appointment');
            const selectedOption = appointment.options[appointment.selectedIndex];
            const feedbackType = document.querySelector('input[name="feedbackType"]:checked').value;
            const rating = document.querySelector('input[name="rating"]:checked');
            const comments = document.getElementById('comments').value;
            
            if (!rating) {
                alert('Please select a rating');
                return;
            }
            
            const feedbackData = {
                appointment_id: appointment.value,
                feedback_type: feedbackType,
                target_id: feedbackType === 'doctor' ? selectedOption.dataset.doctor : selectedOption.dataset.centre,
                rating: parseInt(rating.value),
                comments: comments
            };
            
            try {
                const response = await fetch('/patient/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(feedbackData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Thank you for your feedback! It has been submitted successfully.');
                    window.location.href = '/patient/dashboard';
                } else {
                    alert(result.message || 'Failed to submit feedback. Please try again.');
                }
            } catch (error) {
                console.error('Feedback submission error:', error);
                alert('Failed to submit feedback. Please try again.');
            }
        });
    }
});
</script>
{% endblock %}
