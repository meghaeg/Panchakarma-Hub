{% extends "base.html" %}

{% block title %}Doctor Dashboard - Panchakarma Portal{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-1">Dr. {{ session.name }} - Doctor Dashboard</h4>
                            <p class="text-muted mb-0">Manage patient treatments and track therapy progress</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="addVitals()">
                                    <i class="fas fa-heartbeat"></i> Record Vitals
                                </button>
                                <button class="btn btn-success" onclick="addProgress()">
                                    <i class="fas fa-notes-medical"></i> Add Progress
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-users text-primary" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">{{ appointments|selectattr('status', 'equalto', 'confirmed')|list|length }}</h5>
                    <p class="text-muted mb-0">Assigned Patients</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-play-circle text-warning" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">{{ appointments|selectattr('status', 'equalto', 'in_progress')|list|length }}</h5>
                    <p class="text-muted mb-0">Ongoing Treatments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">{{ appointments|selectattr('status', 'equalto', 'completed')|list|length }}</h5>
                    <p class="text-muted mb-0">Completed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-day text-info" style="font-size: 2rem;"></i>
                    <h5 class="mt-2">{{ appointments|length }}</h5>
                    <p class="text-muted mb-0">Total Patients</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Patient List -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users"></i> My Patients</h5>
                </div>
                <div class="card-body">
                    {% if appointments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Therapy</th>
                                        <th>Start Date</th>
                                        <th>Time Slot</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in appointments %}
                                    <tr>
                                        <td>
                                            <div>
                                                <strong>{{ appointment.patient_name or 'N/A' }}</strong>
                                                <br><small class="text-muted">ID: {{ appointment.patient_id }}</small>
                                                {% if appointment.patient_email %}
                                                <br><small class="text-info"><i class="fas fa-envelope"></i> {{ appointment.patient_email }}</small>
                                                {% endif %}
                                                {% if appointment.patient_phone %}
                                                <br><small class="text-success"><i class="fas fa-phone"></i> {{ appointment.patient_phone }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>{{ appointment.therapy_type }}</td>
                                        <td>{{ appointment.appointment_date if appointment.appointment_date else 'N/A' }}</td>
                                        <td>
                                            {% if appointment.time_slot %}
                                                <span class="badge bg-primary">{{ appointment.time_slot }}</span>
                                            {% else %}
                                                <span class="text-muted">Not assigned</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 6px;">
                                                {% set progress_days = appointment.progress_notes|length %}
                                                {% set total_days = 21 if 'Full' in appointment.therapy_type else 7 %}
                                                {% set progress_percent = (progress_days / total_days * 100) if total_days > 0 else 0 %}
                                                <div class="progress-bar bg-success" style="width: {{ progress_percent }}%"></div>
                                            </div>
                                            <small class="text-muted">{{ progress_days }}/{{ total_days }} days</small>
                                        </td>
                                        <td>
                                            <span class="status-badge status-{{ appointment.status }}">
                                                {{ appointment.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('doctor.view_patient', appointment_id=appointment.appointment_id) }}" 
                                                   class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                {% if appointment.status == 'confirmed' %}
                                                <button class="btn btn-outline-warning start-therapy-btn" 
                                                        data-appointment-id="{{ appointment.appointment_id }}"
                                                        data-appointment-date="{{ appointment.appointment_date }}"
                                                        onclick="startTherapy('{{ appointment.appointment_id }}', '{{ appointment.appointment_date }}')">
                                                    <i class="fas fa-play"></i> Start Therapy
                                                </button>
                                                {% endif %}
                                                {% if appointment.status in ['confirmed', 'in_progress'] %}
                                                <button class="btn btn-outline-success" 
                                                        onclick="quickUpdate('{{ appointment.appointment_id }}')">
                                                    <i class="fas fa-plus"></i> Update
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-user-injured text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">No patients assigned yet</h5>
                            <p class="text-muted">Patients will appear here once assigned by the centre</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Today's Schedule & Quick Actions -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Today's Schedule</h5>
                </div>
                <div class="card-body">
                    {% set today_appointments = appointments|selectattr('appointment_date')|selectattr('appointment_date', 'equalto', today)|list %}
                    {% if today_appointments %}
                        {% for appointment in today_appointments %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ appointment.patient_name }}</h6>
                                <p class="text-muted small mb-0">{{ appointment.therapy_type }}</p>
                                <small class="text-info">{{ appointment.time_slot or 'Time TBD' }}</small>
                            </div>
                            <div>
                                <span class="status-badge status-{{ appointment.status }}">
                                    {{ appointment.status.title() }}
                                </span>
                            </div>
                        </div>
                        <hr>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-calendar-times text-muted" style="font-size: 2rem;"></i>
                            <p class="mt-2 text-muted small">No appointments today</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="addVitals()">
                            <i class="fas fa-heartbeat"></i> Record Patient Vitals
                        </button>
                        <button class="btn btn-success" onclick="addProgress()">
                            <i class="fas fa-notes-medical"></i> Add Progress Note
                        </button>
                        <button class="btn btn-warning" onclick="completeTherapy()">
                            <i class="fas fa-check-circle"></i> Complete Therapy
                        </button>
                        <button class="btn btn-outline-info" onclick="viewReports()">
                            <i class="fas fa-chart-line"></i> View Reports
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ayurvedic Reminder -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-leaf"></i> Ayurvedic Principle</h5>
                </div>
                <div class="card-body">
                    <blockquote class="blockquote">
                        <p class="mb-0 small">"The doctor who treats the disease may win or lose, but the doctor who treats the person with the disease will always win."</p>
                        <footer class="blockquote-footer mt-2">
                            <cite title="Source Title">Ancient Ayurvedic Wisdom</cite>
                        </footer>
                    </blockquote>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Update Modal -->
<div class="modal fade" id="quickUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickUpdateForm">
                    <input type="hidden" id="updateAppointmentId">
                    <div class="mb-3">
                        <label class="form-label">Update Type</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="updateType" id="vitalsUpdate" value="vitals" checked>
                            <label class="btn btn-outline-primary" for="vitalsUpdate">Vitals</label>
                            <input type="radio" class="btn-check" name="updateType" id="progressUpdate" value="progress">
                            <label class="btn btn-outline-success" for="progressUpdate">Progress</label>
                        </div>
                    </div>
                    
                    <div id="vitalsFields">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label for="bpSystolic" class="form-label">BP Systolic</label>
                                <input type="number" class="form-control" id="bpSystolic">
                            </div>
                            <div class="col-6 mb-3">
                                <label for="bpDiastolic" class="form-label">BP Diastolic</label>
                                <input type="number" class="form-control" id="bpDiastolic">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="bloodSugar" class="form-label">Blood Sugar (mg/dL)</label>
                            <input type="number" class="form-control" id="bloodSugar">
                        </div>
                    </div>
                    
                    <div id="progressFields" style="display: none;">
                        <div class="mb-3">
                            <label for="improvementScore" class="form-label">Improvement Score (1-10)</label>
                            <input type="range" class="form-range" id="improvementScore" min="1" max="10" value="5">
                            <div class="text-center">
                                <span id="scoreValue">5</span>/10
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="updateNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="updateNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuickUpdate()">Save Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function quickUpdate(appointmentId) {
    document.getElementById('updateAppointmentId').value = appointmentId;
    const modal = new bootstrap.Modal(document.getElementById('quickUpdateModal'));
    modal.show();
}

// Handle update type toggle
document.querySelectorAll('input[name="updateType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const vitalsFields = document.getElementById('vitalsFields');
        const progressFields = document.getElementById('progressFields');
        
        if (this.value === 'vitals') {
            vitalsFields.style.display = 'block';
            progressFields.style.display = 'none';
        } else {
            vitalsFields.style.display = 'none';
            progressFields.style.display = 'block';
        }
    });
});

// Update improvement score display
document.getElementById('improvementScore').addEventListener('input', function() {
    document.getElementById('scoreValue').textContent = this.value;
});

async function saveQuickUpdate() {
    const appointmentId = document.getElementById('updateAppointmentId').value;
    const updateType = document.querySelector('input[name="updateType"]:checked').value;
    const notes = document.getElementById('updateNotes').value;
    
    let endpoint, data;
    
    if (updateType === 'vitals') {
        endpoint = '/doctor/add-vitals';
        data = {
            appointment_id: appointmentId,
            bp_systolic: document.getElementById('bpSystolic').value,
            bp_diastolic: document.getElementById('bpDiastolic').value,
            blood_sugar: document.getElementById('bloodSugar').value,
            notes: notes
        };
    } else {
        endpoint = '/doctor/add-progress';
        data = {
            appointment_id: appointmentId,
            improvement_score: document.getElementById('improvementScore').value,
            notes: notes
        };
    }
    
    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Update saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('quickUpdateModal')).hide();
            location.reload();
        } else {
            alert(result.message || 'Update failed');
        }
    } catch (error) {
        console.error('Update error:', error);
        alert('Update failed. Please try again.');
    }
}

function addVitals() {
    // Show modal to select patient for vitals
    const patients = {{ appointments|tojson }};
    if (patients.length === 0) {
        alert('No patients assigned to you yet');
        return;
    }
    
    let options = 'Select a patient to record vitals:\n';
    patients.forEach((apt, index) => {
        options += `${index + 1}. ${apt.patient_name || 'Unknown'} (${apt.therapy_type})\n`;
    });
    
    const choice = prompt(options);
    if (choice && !isNaN(choice) && choice > 0 && choice <= patients.length) {
        const selectedAppointment = patients[choice - 1];
        document.getElementById('updateAppointmentId').value = selectedAppointment.appointment_id;
        document.querySelector('input[name="updateType"][value="vitals"]').checked = true;
        document.getElementById('vitalsFields').style.display = 'block';
        document.getElementById('progressFields').style.display = 'none';
        const modal = new bootstrap.Modal(document.getElementById('quickUpdateModal'));
        modal.show();
    }
}

function addProgress() {
    // Show modal to select patient for progress
    const patients = {{ appointments|tojson }};
    if (patients.length === 0) {
        alert('No patients assigned to you yet');
        return;
    }
    
    let options = 'Select a patient to add progress notes:\n';
    patients.forEach((apt, index) => {
        options += `${index + 1}. ${apt.patient_name || 'Unknown'} (${apt.therapy_type})\n`;
    });
    
    const choice = prompt(options);
    if (choice && !isNaN(choice) && choice > 0 && choice <= patients.length) {
        const selectedAppointment = patients[choice - 1];
        document.getElementById('updateAppointmentId').value = selectedAppointment.appointment_id;
        document.querySelector('input[name="updateType"][value="progress"]').checked = true;
        document.getElementById('vitalsFields').style.display = 'none';
        document.getElementById('progressFields').style.display = 'block';
        const modal = new bootstrap.Modal(document.getElementById('quickUpdateModal'));
        modal.show();
    }
}

function completeTherapy() {
    // Show modal to select patient for therapy completion
    const patients = {{ appointments|tojson }};
    const activePatients = patients.filter(apt => apt.status === 'confirmed' || apt.status === 'in_progress');
    
    if (activePatients.length === 0) {
        alert('No active patients to complete therapy for');
        return;
    }
    
    let options = 'Select a patient to complete therapy:\n';
    activePatients.forEach((apt, index) => {
        options += `${index + 1}. ${apt.patient_name || 'Unknown'} (${apt.therapy_type})\n`;
    });
    
    const choice = prompt(options);
    if (choice && !isNaN(choice) && choice > 0 && choice <= activePatients.length) {
        const selectedAppointment = activePatients[choice - 1];
        const summary = prompt('Enter therapy completion summary:');
        const recommendations = prompt('Enter post-therapy recommendations:');
        
        if (summary) {
            fetch('/doctor/complete-therapy-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    appointment_id: selectedAppointment.appointment_id,
                    summary: summary,
                    recommendations: recommendations || 'Follow general Ayurvedic lifestyle practices'
                })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    alert('Therapy completed successfully!');
                    location.reload();
                } else {
                    alert(d.message || 'Failed to complete therapy');
                }
            })
            .catch(() => alert('Failed to complete therapy'));
        }
    }
}

function startTherapy(appointmentId, appointmentDate) {
    // Check if appointment date has arrived
    const today = new Date();
    const aptDate = new Date(appointmentDate);
    
    // Reset time to compare only dates
    today.setHours(0, 0, 0, 0);
    aptDate.setHours(0, 0, 0, 0);
    
    if (aptDate > today) {
        const dateStr = aptDate.toLocaleDateString('en-GB');
        alert(`Therapy cannot be started yet. Appointment date is ${dateStr}. Please wait until the appointment date arrives.`);
        return;
    }
    
    if (confirm('Are you sure you want to start therapy for this patient?')) {
        fetch('/doctor/start-therapy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ appointment_id: appointmentId })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                alert('Therapy started successfully!');
                location.reload();
            } else {
                alert(d.message || 'Failed to start therapy');
            }
        })
        .catch(() => alert('Failed to start therapy'));
    }
}

function viewReports() {
    alert('Reports functionality will be implemented');
}

// Enable/disable start therapy buttons based on appointment date
document.addEventListener('DOMContentLoaded', function() {
    const startTherapyButtons = document.querySelectorAll('.start-therapy-btn');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    startTherapyButtons.forEach(button => {
        const appointmentDate = new Date(button.dataset.appointmentDate);
        appointmentDate.setHours(0, 0, 0, 0);
        
        if (appointmentDate > today) {
            button.disabled = true;
            button.classList.add('disabled');
            button.title = `Therapy can be started on ${appointmentDate.toLocaleDateString('en-GB')}`;
        } else {
            button.title = 'Click to start therapy';
        }
    });
});
</script>
{% endblock %}
