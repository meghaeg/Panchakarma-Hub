{% extends "base.html" %}

{% block title %}Bed Management - Panchakarma Portal{% endblock %}

{% block content %}
<div class="container py-4">
	<!-- Header Section -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card dashboard-card">
				<div class="card-body">
					<div class="row align-items-center">
						<div class="col-md-8">
							<h4 class="mb-1"><i class="fas fa-bed"></i> Bed Management</h4>
							<p class="text-muted mb-0">Manage bed allocation, occupancy, and patient stays</p>
						</div>
						<div class="col-md-4 text-end">
							<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBedModal">
								<i class="fas fa-plus"></i> Add New Bed
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Statistics Cards -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<i class="fas fa-bed text-primary" style="font-size: 2rem;"></i>
					<h5 class="mt-2">{{ stats.total }}</h5>
					<p class="text-muted mb-0">Total Beds</p>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
					<h5 class="mt-2">{{ stats.available }}</h5>
					<p class="text-muted mb-0">Available</p>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<i class="fas fa-user text-danger" style="font-size: 2rem;"></i>
					<h5 class="mt-2">{{ stats.occupied }}</h5>
					<p class="text-muted mb-0">Occupied</p>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<i class="fas fa-broom text-warning" style="font-size: 2rem;"></i>
					<h5 class="mt-2">{{ stats.under_cleaning }}</h5>
					<p class="text-muted mb-0">Cleaning</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Filters and Search -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="row">
						<div class="col-md-3">
							<label for="bedTypeFilter" class="form-label">Bed Type</label>
							<select class="form-control" id="bedTypeFilter">
								<option value="">All Types</option>
								<option value="general_ward">General Ward</option>
								<option value="special_room">Special Room</option>
								<option value="panchakarma_therapy">Panchakarma Therapy</option>
							</select>
						</div>
						<div class="col-md-3">
							<label for="statusFilter" class="form-label">Status</label>
							<select class="form-control" id="statusFilter">
								<option value="">All Status</option>
								<option value="available">Available</option>
								<option value="occupied">Occupied</option>
								<option value="under_cleaning">Under Cleaning</option>
								<option value="reserved">Reserved</option>
							</select>
						</div>
						<div class="col-md-3">
							<label for="roomFilter" class="form-label">Room Number</label>
							<input type="text" class="form-control" id="roomFilter" placeholder="Search by room...">
						</div>
						<div class="col-md-3">
							<label for="patientFilter" class="form-label">Patient Name</label>
							<input type="text" class="form-control" id="patientFilter" placeholder="Search by patient...">
						</div>
					</div>
					<div class="row mt-3">
						<div class="col-12">
							<button class="btn btn-primary" onclick="applyFilters()">
								<i class="fas fa-search"></i> Apply Filters
							</button>
							<button class="btn btn-outline-secondary" onclick="clearFilters()">
								<i class="fas fa-times"></i> Clear Filters
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Bed Grid -->
	<div class="row">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-th"></i> Bed Grid View</h5>
				</div>
				<div class="card-body">
					<div id="bedGrid" class="bed-grid">
						<!-- Beds will be loaded here dynamically -->
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Bed Details Table -->
	<div class="row mt-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-list"></i> Bed Details</h5>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-hover" id="bedTable">
							<thead>
								<tr>
									<th>Bed ID</th>
									<th>Type</th>
									<th>Room</th>
									<th>Status</th>
									<th>Patient</th>
									<th>Price/Day</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for bed in beds %}
								<tr data-bed-id="{{ bed.bed_id }}">
									<td><strong>{{ bed.bed_id }}</strong></td>
									<td>
										<span class="badge bg-info">
											{{ bed.bed_type.replace('_', ' ').title() }}
										</span>
									</td>
									<td>{{ bed.room_number }}</td>
									<td>
										<span class="status-badge status-{{ bed.status }}">
											{{ bed.status.replace('_', ' ').title() }}
										</span>
									</td>
									<td>
										{% if bed.current_patient_name %}
											{{ bed.current_patient_name }}
										{% else %}
											<span class="text-muted">-</span>
										{% endif %}
									</td>
									<td>₹{{ bed.price_per_day }}</td>
									<td>
										<div class="btn-group btn-group-sm">
											{% if bed.status == 'available' %}
												<button class="btn btn-success" onclick="allocateBed('{{ bed.bed_id }}')">
													<i class="fas fa-user-plus"></i> Allocate
												</button>
												<button class="btn btn-warning" onclick="reserveBed('{{ bed.bed_id }}')">
													<i class="fas fa-bookmark"></i> Reserve
												</button>
											{% elif bed.status == 'occupied' %}
												<button class="btn btn-danger" onclick="checkoutBed('{{ bed.bed_id }}')">
													<i class="fas fa-sign-out-alt"></i> Checkout
												</button>
											{% elif bed.status == 'under_cleaning' %}
												<button class="btn btn-success" onclick="markAvailable('{{ bed.bed_id }}')">
													<i class="fas fa-check"></i> Mark Available
												</button>
											{% elif bed.status == 'reserved' %}
												<button class="btn btn-primary" onclick="allocateBed('{{ bed.bed_id }}')">
													<i class="fas fa-user-plus"></i> Allocate
												</button>
												<button class="btn btn-danger" onclick="cancelReservation('{{ bed.bed_id }}')">
													<i class="fas fa-times"></i> Cancel
												</button>
											{% endif %}
											<button class="btn btn-outline-info" onclick="viewBedDetails('{{ bed.bed_id }}')">
												<i class="fas fa-eye"></i> View
											</button>
										</div>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Add Bed Modal -->
<div class="modal fade" id="addBedModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Add New Bed</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form id="addBedForm">
					<div class="mb-3">
						<label for="bedType" class="form-label">Bed Type</label>
						<select class="form-control" id="bedType" required>
							<option value="">Select Bed Type</option>
							<option value="general_ward">General Ward</option>
							<option value="special_room">Special Room</option>
							<option value="panchakarma_therapy">Panchakarma Therapy</option>
						</select>
					</div>
					<div class="mb-3">
						<label for="roomNumber" class="form-label">Room Number</label>
						<input type="text" class="form-control" id="roomNumber" required>
					</div>
					<div class="mb-3">
						<label for="location" class="form-label">Location/Floor</label>
						<input type="text" class="form-control" id="location" placeholder="e.g., Ground Floor, Ward A">
					</div>
					<div class="mb-3">
						<label for="pricePerDay" class="form-label">Price per Day (₹)</label>
						<input type="number" class="form-control" id="pricePerDay" min="0" step="0.01">
					</div>
					<div class="mb-3">
						<label class="form-label">Features</label>
						<div class="row">
							<div class="col-md-6">
								<div class="form-check">
									<input class="form-check-input" type="checkbox" id="feature_ac" value="ac">
									<label class="form-check-label" for="feature_ac">Air Conditioning</label>
								</div>
								<div class="form-check">
									<input class="form-check-input" type="checkbox" id="feature_tv" value="tv">
									<label class="form-check-label" for="feature_tv">TV</label>
								</div>
								<div class="form-check">
									<input class="form-check-input" type="checkbox" id="feature_wifi" value="wifi">
									<label class="form-check-label" for="feature_wifi">WiFi</label>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-check">
									<input class="form-check-input" type="checkbox" id="feature_bathroom" value="private_bathroom">
									<label class="form-check-label" for="feature_bathroom">Private Bathroom</label>
								</div>
								<div class="form-check">
									<input class="form-check-input" type="checkbox" id="feature_balcony" value="balcony">
									<label class="form-check-label" for="feature_balcony">Balcony</label>
								</div>
								<div class="form-check">
									<input class="form-check-input" type="checkbox" id="feature_refrigerator" value="refrigerator">
									<label class="form-check-label" for="feature_refrigerator">Refrigerator</label>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="addBed()">Add Bed</button>
			</div>
		</div>
	</div>
</div>

<!-- Patient Selection Modal -->
<div class="modal fade" id="patientSelectModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Select Patient</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<input type="hidden" id="selectedBedId">
				<input type="hidden" id="actionType">
				<div class="mb-3">
					<label for="patientSearch" class="form-label">Search Patient</label>
					<input type="text" class="form-control" id="patientSearch" placeholder="Search by name or ID...">
				</div>
				<div id="patientList" class="list-group" style="max-height: 300px; overflow-y: auto;">
					{% for patient in recent_patients %}
					<div class="list-group-item list-group-item-action" data-patient-id="{{ patient.patient_id }}" onclick="selectPatient('{{ patient.patient_id }}', '{{ patient.name }}')">
						<div class="d-flex w-100 justify-content-between">
							<h6 class="mb-1">{{ patient.name }}</h6>
							<small>{{ patient.patient_id }}</small>
						</div>
						<p class="mb-1">{{ patient.email }}</p>
						<small>{{ patient.phone }}</small>
					</div>
					{% endfor %}
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
			</div>
		</div>
	</div>
</div>

<!-- Bed Details Modal -->
<div class="modal fade" id="bedDetailsModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Bed Details</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body" id="bedDetailsContent">
				<!-- Bed details will be loaded here -->
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bed-grid {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
	gap: 15px;
	padding: 20px;
}

.bed-card {
	border: 2px solid #dee2e6;
	border-radius: 10px;
	padding: 15px;
	text-align: center;
	cursor: pointer;
	transition: all 0.3s ease;
	min-height: 120px;
	display: flex;
	flex-direction: column;
	justify-content: center;
	position: relative;
}

.bed-card:hover {
	transform: translateY(-2px);
	box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.bed-card.available {
	border-color: #28a745;
	background-color: #d4edda;
}

.bed-card.occupied {
	border-color: #dc3545;
	background-color: #f8d7da;
}

.bed-card.under_cleaning {
	border-color: #ffc107;
	background-color: #fff3cd;
}

.bed-card.reserved {
	border-color: #17a2b8;
	background-color: #d1ecf1;
}

.bed-icon {
	font-size: 2rem;
	margin-bottom: 10px;
}

.bed-id {
	font-weight: bold;
	font-size: 1.1rem;
	margin-bottom: 5px;
}

.bed-type {
	font-size: 0.9rem;
	color: #6c757d;
	margin-bottom: 5px;
}

.bed-room {
	font-size: 0.8rem;
	color: #6c757d;
}

.bed-patient {
	font-size: 0.8rem;
	font-weight: bold;
	margin-top: 5px;
}

.status-badge {
	padding: 4px 8px;
	border-radius: 4px;
	font-size: 0.8rem;
	font-weight: bold;
}

.status-available {
	background-color: #d4edda;
	color: #155724;
}

.status-occupied {
	background-color: #f8d7da;
	color: #721c24;
}

.status-under_cleaning {
	background-color: #fff3cd;
	color: #856404;
}

.status-reserved {
	background-color: #d1ecf1;
	color: #0c5460;
}

.patient-search-item {
	cursor: pointer;
}

.patient-search-item:hover {
	background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/bed-management.js') }}"></script>
{% endblock %}
